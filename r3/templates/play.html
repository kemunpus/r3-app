{% extends "base.html" %}
<!-- Head -->
{% block head %}
<script type="text/javascript">
    const interval = Number("{{trial.logic.interval}}") * 1000

    let counter = null;
    let text = null;
    let image = null;
    let video = null;

    let start = 0;
    let last = 0;
    let timer = null;
    let seq = 0;

    window.onload = () => {
        counter = document.getElementById("counter");

        text = document.getElementById("text");
        text.style.display = "none";

        image = document.getElementById("image");
        image.style.display = "none";

        image.onload = () => {
            image.style.display = "block";
        }

        video = document.getElementById("video");
        video.style.display = "none";

        video.onloadeddata = () => {
            video.style.display = "block";
        }

        start = new Date().getTime();
        last = start - interval;
        timer = setInterval(onInterval, 1000 / 2);

        onInterval();
    }

    function onInterval() {
        const now = new Date().getTime();

        const diff = now - start;
        const min = Math.floor(diff / (1000 * 60));
        const sec = Math.floor(diff / 1000) - (min * 60);

        counter.innerHTML = String(min).padStart(2, "0") + ":" + String(sec).padStart(2, "0");

        if (now >= (last + interval)) {
            last = now;

            content_url = "../content/{{trial.pk}}/" + String(seq)
            seq++;

            fetch(content_url).then((response) => {
                text.style.display = "none";
                image.style.display = "none";
                video.style.display = "none";

                if (response.ok) {
                    return response.json();
                }

                text.innerHTML = "API Error : " + response.status + " (@" + seq + ")<br>may be you have to re-run prep?";
                text.style.display = "block";

            }).then((data) => {

                if (data.ext == "jpg" || data.ext == "png") {
                    image.src = data.url;

                } else if (data.ext == "mp4" || data.ext == "webm" || data.ext == "ogg") {
                    video.src = data.url;

                } else if (data.ext == "txt") {
                    text.innerHTML = data.url;
                    text.style.display = "block";

                } else {
                    text.innerHTML = "ext [" + data.ext + "] (" + data.url + ") does not support yet.";
                    text.style.display = "block";
                }

            }).catch((error) => {
                console.log(`api call failed : ${content_url}`);
            });
        }
    }
</script>
{% endblock %}
<!-- Header-->
{% block header %}
<div class="header">
    <div class="title">R3</div>
    <div class="marks">
        <div class="mark">Setup</div>
        <div class="space">></div>
        <div class="mark">Check</div>
        <div class="space">></div>
        <div class="current">Show</div>
        <div class="space">></div>
        <div class="mark">Finish</div>
    </div>
</div>
{% endblock %}
<!-- Body -->
{% block body %}
<form action="../finish/{{trial.pk}}" method="GET">
    {% csrf_token %}
    <div class="data">
        <div class="name">
            Room:
        </div>
        <div class="value">
            {{trial.room}}</td>
        </div>
    </div>
    <div class="data">
        <div class="name">
            Nickname:
        </div>
        <div class="value">
            {{trial.nickname}}</td>
        </div>
    </div>
    <div class="data">
        <div class="name">
            Time:
        </div>
        <div id="counter" class="value">
            00:00
        </div>
    </div>
    <button class="finish" type="submit">Finish</button>
    <div id="container" class="container">
        <div id="text" class="content"></div>
        <img id="image" class="content" />
        <video id="video" class="content" onloadstart="this.volume=0.0" autoplay muted loop preload="none"></video>
    </div>
</form>
{% endblock %}